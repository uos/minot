image: rust:latest

variables:
  CARGO_INCREMENTAL: "0"
  RUST_BACKTRACE: "full"

stages:
  - build
  - archive

before_script:
  - apt-get update
  - apt-get install -y curl gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu musl-tools libc6-dev-riscv64-cross gcc-arm-linux-gnueabihf

rust-latest:
  stage: build
  script:
    - rustup default stable
    - cargo build --verbose
    - cargo test --verbose
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

rust-nightly:
  stage: build
  image: rust:nightly
  script:
    - cargo build --verbose
    - cargo test --verbose
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

.build_template: &build_defaults
  stage: build
  script:
    - rustup target add $RUST_TARGET
    - RUSTFLAGS="-C target-feature=+crt-static" cargo build --target $RUST_TARGET --release
    - mv target/$RUST_TARGET/release/liol liol-$TRIPLE
    - mv target/$RUST_TARGET/release/librat.a librat.a
    - cargo build --target $RUST_TARGET --release --lib
    - mv target/$RUST_TARGET/release/librat.so librat.so
  artifacts:
    paths:
      - liol-$TRIPLE
      - librat.so
      - librat.a
      - librat.rlib
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always

build:linux:x86_64-musl:
  stage: archive
  script:
    - rustup target add $RUST_TARGET
    - RUSTFLAGS="-C target-feature=+crt-static" cargo build --target $RUST_TARGET --release
    - mv target/$RUST_TARGET/release/liol liol-$TRIPLE
    - mv target/$RUST_TARGET/release/librat.a librat.a
    - mv target/$RUST_TARGET/release/librat.rlib librat.rlib
  artifacts:
    paths:
      - liol-$TRIPLE
      - librat.a
      - librat.rlib
  variables:
    RUST_TARGET: x86_64-unknown-linux-musl
    TRIPLE: x86_64-linux-musl

build:linux:x86_64-gnu:
  <<: *build_defaults
  variables:
    RUST_TARGET: x86_64-unknown-linux-gnu
    TRIPLE: x86_64-linux-gnu

build:linux:aarch64:
  <<: *build_defaults
  variables:
    RUST_TARGET: aarch64-unknown-linux-gnu
    TRIPLE: aarch64-linux-gnu

build:linux:armv7:
  <<: *build_defaults
  variables:
    RUST_TARGET: armv7-unknown-linux-gnueabihf
    TRIPLE: armv7-linux-gnueabihf

build:linux:riscv64:
  <<: *build_defaults
  variables:
    RUST_TARGET: riscv64gc-unknown-linux-gnu
    TRIPLE: riscv64gc-linux-gnu

build:linux:riscv64-musl:
  stage: archive
  script:
    - rustup target add $RUST_TARGET
    - curl -L https://musl.cc/riscv64-linux-musl-cross.tgz | tar xz
    - RUSTFLAGS="-C target-feature=+crt-static" cargo build --target $RUST_TARGET --release
    - mv target/$RUST_TARGET/release/liol liol-$TRIPLE
    - mv target/$RUST_TARGET/release/librat.a librat.a
    - mv target/$RUST_TARGET/release/librat.rlib librat.rlib
    - cargo build --target $RUST_TARGET --release --lib
    - mv target/$RUST_TARGET/release/librat.so librat.so
  artifacts:
    paths:
      - liol-$TRIPLE
      - librat.so
      - librat.a
      - librat.rlib
  variables:
    RUST_TARGET: riscv64gc-unknown-linux-musl
    TRIPLE: riscv64gc-linux-musl
