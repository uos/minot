image: rust:nightly

variables:
  CARGO_INCREMENTAL: "0"
  RUST_BACKTRACE: "full"

stages:
  - build
  - snapshot

before_script:
  - apt-get update
  - apt-get install -y curl gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu musl-tools libc6-dev-riscv64-cross gcc-arm-linux-gnueabihf

rust-stable:
  stage: build
  image: rust:latest
  script:
    - cargo build --verbose
    - cargo test --verbose
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

rust-nightly:
  stage: build
  script:
    - cargo build --verbose
    - cargo test --verbose
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main"'

.build_template: &build_defaults
  stage: snapshot
  script:
    - rustup target add $RUST_TARGET
    - RUSTFLAGS="-C target-feature=+crt-static" cargo build --target $RUST_TARGET --release
    - mv target/$RUST_TARGET/release/liol liol-$TRIPLE-nightly-$DATE
    - mv target/$RUST_TARGET/release/librat.a librat-nightly-$DATE.a
    - cargo build --target $RUST_TARGET --release --lib # needed to build shared library
    - mv target/$RUST_TARGET/release/librat.so librat-nightly-$DATE.so
  artifacts:
    paths:
      - liol-$TRIPLE-nightly-$DATE
      - librat-nightly-$DATE.so
      - librat-nightly-$DATE.a
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always

snapshot:linux:x86_64-musl:
  stage: snapshot
  script:
    - rustup target add $RUST_TARGET
    - RUSTFLAGS="-C target-feature=+crt-static" cargo build --target $RUST_TARGET --release
    - mv target/$RUST_TARGET/release/liol liol-$TRIPLE-nightly-$DATE
    - mv target/$RUST_TARGET/release/librat.a librat-nightly-$DATE.a
  artifacts:
    paths:
      - liol-$TRIPLE-nightly-$DATE
      - librat-nightly-$DATE.a
    expire_in: 1 week
  variables:
    RUST_TARGET: x86_64-unknown-linux-musl
    TRIPLE: x86_64-linux-musl
    DATE: "$(date +%Y-%m-%d)"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always

snapshot:linux:x86_64-gnu:
  <<: *build_defaults
  variables:
    RUST_TARGET: x86_64-unknown-linux-gnu
    TRIPLE: x86_64-linux-gnu
    DATE: "$(date +%Y-%m-%d)"

snapshot:linux:aarch64:
  <<: *build_defaults
  variables:
    RUST_TARGET: aarch64-unknown-linux-gnu
    TRIPLE: aarch64-linux-gnu
    DATE: "$(date +%Y-%m-%d)"

snapshot:linux:armv7:
  <<: *build_defaults
  variables:
    RUST_TARGET: armv7-unknown-linux-gnueabihf
    TRIPLE: armv7-linux-gnueabihf
    DATE: "$(date +%Y-%m-%d)"

snapshot:linux:riscv64:
  <<: *build_defaults
  variables:
    RUST_TARGET: riscv64gc-unknown-linux-gnu
    TRIPLE: riscv64gc-linux-gnu
    DATE: "$(date +%Y-%m-%d)"

snapshot:linux:riscv64-musl:
  stage: snapshot
  script:
    - rustup target add $RUST_TARGET
    - curl -L https://musl.cc/riscv64-linux-musl-cross.tgz | tar xz
    - RUSTFLAGS="-C target-feature=+crt-static" cargo build --target $RUST_TARGET --release
    - mv target/$RUST_TARGET/release/liol liol-$TRIPLE-nightly-$DATE
    - mv target/$RUST_TARGET/release/librat.a librat-nightly-$DATE.a
    - cargo build --target $RUST_TARGET --release --lib # needed to build shared library
    - mv target/$RUST_TARGET/release/librat.so librat-nightly-$DATE.so
  artifacts:
    paths:
      - liol-$TRIPLE-nightly-$DATE
      - librat-nightly-$DATE.so
      - librat-nightly-$DATE.a
    expire_in: 1 week
  variables:
    RUST_TARGET: riscv64gc-unknown-linux-musl
    TRIPLE: riscv64gc-linux-musl
    DATE: "$(date +%Y-%m-%d)"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
