name: release

on:
  push:
    tags:
      - v*
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write

jobs:
  rust-stable-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Dependencies
        run: |
          sudo apt-get install -y curl git unzip clang
          curl -sLo dlg_cut.zip "https://myshare.uni-osnabrueck.de/f/5faf4154af384854ab94?dl=1" && unzip dlg_cut.zip && rm dlg_cut.zip
      - name: Test
        run: cargo test --verbose

  # -------------------------------------------------------------------------
  # STANDARD LINUX TARGETS (Musl, GNU x86/ARM)
  # Builds: minimal, coord, ratpub
  # -------------------------------------------------------------------------

  linux-x86_64-musl:
    runs-on: ubuntu-latest
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      - name: Build Variants
        env:
          RUST_TARGET: x86_64-unknown-linux-musl
        run: |
          rustup target add $RUST_TARGET
          # Helper alias for static linking
          CARGO_CMD="cargo build --target $RUST_TARGET --release"
          export RUSTFLAGS="-C target-feature=+crt-static"

          # 1. Minimal (min)
          $CARGO_CMD --package minot --bin minot --no-default-features
          mkdir -p dist/min && cp target/$RUST_TARGET/release/minot dist/min/

          # 2. Coord (co)
          $CARGO_CMD --package minot --bin minot --features embed-coord
          mkdir -p dist/co && cp target/$RUST_TARGET/release/minot dist/co/

          # 3. Ratpub (rat)
          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ratpub
          mkdir -p dist/rat && cp target/$RUST_TARGET/release/minot dist/rat/

          # 4. Sidecars & Libs
          $CARGO_CMD --package minot --bin minot-coord
          $CARGO_CMD --package mt_wind --bin wind-rat --features ratpub
          $CARGO_CMD --package mt_wind --bin wind-ros2-native --features ros2-native
          $CARGO_CMD --package mt_rat --lib 
          
          # Move shared artifacts to root of dist
          cp target/$RUST_TARGET/release/minot-coord dist/
          cp target/$RUST_TARGET/release/wind-rat dist/
          cp target/$RUST_TARGET/release/wind-ros2-native dist/
          cp target/$RUST_TARGET/release/librat.a dist/
          cp mt_rat/rat.h dist/

      - name: "Archive binary"
        run: |
          TARGET=x86_64-unknown-linux-musl
          mv dist minot-$TARGET
          tar czvf minot-$TARGET.tar.gz minot-$TARGET
          shasum -a 256 minot-$TARGET.tar.gz > minot-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-x86_64-unknown-linux-musl
          path: |
            *.tar.gz
            *.sha256

  linux-x86_64-gnu:
    runs-on: ubuntu-latest
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Variants
        env:
          RUST_TARGET: x86_64-unknown-linux-gnu
        run: |
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          # 1. Minimal (min)
          $CARGO_CMD --package minot --bin minot --no-default-features
          mkdir -p dist/min && cp target/$RUST_TARGET/release/minot dist/min/

          # 2. Coord (co)
          $CARGO_CMD --package minot --bin minot --features embed-coord
          mkdir -p dist/co && cp target/$RUST_TARGET/release/minot dist/co/

          # 3. Ratpub (rat)
          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ratpub
          mkdir -p dist/rat && cp target/$RUST_TARGET/release/minot dist/rat/

          # 4. Sidecars & Libs
          $CARGO_CMD --package minot --bin minot-coord
          $CARGO_CMD --package mt_wind --bin wind-rat --features ratpub
          $CARGO_CMD --package mt_wind --bin wind-ros2-native --features ros2-native
          $CARGO_CMD --package mt_wind --bin wind-ros1-native --features ros1-native
          $CARGO_CMD --package mt_rat --lib 
          
          cp target/$RUST_TARGET/release/minot-coord dist/
          cp target/$RUST_TARGET/release/wind-rat dist/
          cp target/$RUST_TARGET/release/wind-ros2-native dist/
          cp target/$RUST_TARGET/release/wind-ros1-native dist/
          cp target/$RUST_TARGET/release/librat.a dist/
          cp target/$RUST_TARGET/release/librat.so dist/
          cp mt_rat/rat.h dist/

      - name: "Archive binary"
        run: |
          TARGET=x86_64-unknown-linux-gnu
          mv dist minot-$TARGET
          tar czvf minot-$TARGET.tar.gz minot-$TARGET
          shasum -a 256 minot-$TARGET.tar.gz > minot-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-x86_64-unknown-linux-gnu
          path: |
            *.tar.gz
            *.sha256

  # Note: Repeating logic for other architectures (arm, aarch64) without ROS
  # To save space, I'm assuming you want these patterns applied to the linux-aarch64-gnu 
  # and linux-armv7-gnu jobs similarly to linux-x86_64-gnu above.

  linux-aarch64-gnu:
    runs-on: ubuntu-latest
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build Variants
        env:
          RUST_TARGET: aarch64-unknown-linux-gnu
        run: |
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          # Variants
          $CARGO_CMD --package minot --bin minot --no-default-features
          mkdir -p dist/min && cp target/$RUST_TARGET/release/minot dist/min/

          $CARGO_CMD --package minot --bin minot --features embed-coord
          mkdir -p dist/co && cp target/$RUST_TARGET/release/minot dist/co/

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ratpub
          mkdir -p dist/rat && cp target/$RUST_TARGET/release/minot dist/rat/

          # Sidecars
          $CARGO_CMD --package minot --bin minot-coord
          $CARGO_CMD --package mt_rat --lib 

          cp target/$RUST_TARGET/release/minot-coord dist/
          cp target/$RUST_TARGET/release/librat.a dist/
          cp target/$RUST_TARGET/release/librat.so dist/
          cp mt_rat/rat.h dist/

      - name: "Archive binary"
        run: |
          TARGET=aarch64-unknown-linux-gnu
          mv dist minot-$TARGET
          tar czvf minot-$TARGET.tar.gz minot-$TARGET
          shasum -a 256 minot-$TARGET.tar.gz > minot-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-aarch64-unknown-linux-gnu
          path: |
            *.tar.gz
            *.sha256

  linux-armv7-gnu:
    runs-on: ubuntu-latest
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc-arm-linux-gnueabihf
      - name: Build Variants
        env:
          RUST_TARGET: armv7-unknown-linux-gnueabihf
        run: |
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          # Variants
          $CARGO_CMD --package minot --bin minot --no-default-features
          mkdir -p dist/min && cp target/$RUST_TARGET/release/minot dist/min/

          $CARGO_CMD --package minot --bin minot --features embed-coord
          mkdir -p dist/co && cp target/$RUST_TARGET/release/minot dist/co/

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ratpub
          mkdir -p dist/rat && cp target/$RUST_TARGET/release/minot dist/rat/

          # Sidecars
          $CARGO_CMD --package minot --bin minot-coord
          $CARGO_CMD --package mt_wind --bin wind-rat --features ratpub
          $CARGO_CMD --package mt_wind --bin wind-ros2-native --features ros2-native
          $CARGO_CMD --package mt_wind --bin wind-ros1-native --features ros1-native
          $CARGO_CMD --package mt_rat --lib 

          cp target/$RUST_TARGET/release/minot-coord dist/
          cp target/$RUST_TARGET/release/wind-rat dist/
          cp target/$RUST_TARGET/release/wind-ros2-native dist/
          cp target/$RUST_TARGET/release/wind-ros1-native dist/
          cp target/$RUST_TARGET/release/librat.a dist/
          cp target/$RUST_TARGET/release/librat.so dist/
          cp mt_rat/rat.h dist/

      - name: "Archive binary"
        run: |
          TARGET=armv7-unknown-linux-gnueabihf
          mv dist minot-$TARGET
          tar czvf minot-$TARGET.tar.gz minot-$TARGET
          shasum -a 256 minot-$TARGET.tar.gz > minot-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-armv7-unknown-linux-gnueabihf
          path: |
            *.tar.gz
            *.sha256

  # -------------------------------------------------------------------------
  # MACOS TARGETS
  # Builds: minimal, coord, ratpub
  # -------------------------------------------------------------------------

  macos-aarch64:
    runs-on: macos-latest
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Variants
        env:
          RUST_TARGET: aarch64-apple-darwin
        run: |
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          $CARGO_CMD --package minot --bin minot --no-default-features
          mkdir -p dist/min && cp target/$RUST_TARGET/release/minot dist/min/

          $CARGO_CMD --package minot --bin minot --features embed-coord
          mkdir -p dist/co && cp target/$RUST_TARGET/release/minot dist/co/

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ratpub
          mkdir -p dist/rat && cp target/$RUST_TARGET/release/minot dist/rat/

          $CARGO_CMD --package minot --bin minot-coord
          $CARGO_CMD --package mt_wind --bin wind-rat --features ratpub
          $CARGO_CMD --package mt_wind --bin wind-ros2-native --features ros2-native
          $CARGO_CMD --package mt_wind --bin wind-ros1-native --features ros1-native
          $CARGO_CMD --package mt_rat --lib 

          cp target/$RUST_TARGET/release/minot-coord dist/
          cp target/$RUST_TARGET/release/wind-rat dist/
          cp target/$RUST_TARGET/release/wind-ros2-native dist/
          cp target/$RUST_TARGET/release/wind-ros1-native dist/
          cp target/$RUST_TARGET/release/librat.a dist/
          cp target/$RUST_TARGET/release/librat.dylib dist/
          cp mt_rat/rat.h dist/

      - name: "Archive binary"
        run: |
          TARGET=aarch64-apple-darwin
          mv dist minot-$TARGET
          tar czvf minot-$TARGET.tar.gz minot-$TARGET
          shasum -a 256 minot-$TARGET.tar.gz > minot-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-aarch64-apple-darwin
          path: |
            *.tar.gz
            *.sha256

  macos-x86_64:
    runs-on: macos-latest
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Variants
        env:
          RUST_TARGET: x86_64-apple-darwin
        run: |
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          $CARGO_CMD --package minot --bin minot --no-default-features
          mkdir -p dist/min && cp target/$RUST_TARGET/release/minot dist/min/

          $CARGO_CMD --package minot --bin minot --features embed-coord
          mkdir -p dist/co && cp target/$RUST_TARGET/release/minot dist/co/

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ratpub
          mkdir -p dist/rat && cp target/$RUST_TARGET/release/minot dist/rat/

          $CARGO_CMD --package minot --bin minot-coord
          $CARGO_CMD --package mt_wind --bin wind-rat --features ratpub
          $CARGO_CMD --package mt_wind --bin wind-ros2-native --features ros2-native
          $CARGO_CMD --package mt_wind --bin wind-ros1-native --features ros1-native
          $CARGO_CMD --package mt_rat --lib 

          cp target/$RUST_TARGET/release/minot-coord dist/
          cp target/$RUST_TARGET/release/wind-rat dist/
          cp target/$RUST_TARGET/release/wind-ros2-native dist/
          cp target/$RUST_TARGET/release/wind-ros1-native dist/
          cp target/$RUST_TARGET/release/librat.a dist/
          cp target/$RUST_TARGET/release/librat.dylib dist/
          cp mt_rat/rat.h dist/

      - name: "Archive binary"
        run: |
          TARGET=x86_64-apple-darwin
          mv dist minot-$TARGET
          tar czvf minot-$TARGET.tar.gz minot-$TARGET
          shasum -a 256 minot-$TARGET.tar.gz > minot-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-x86_64-apple-darwin
          path: |
            *.tar.gz
            *.sha256

  # -------------------------------------------------------------------------
  # ROS TARGETS (Jazzy / Humble)
  # Builds: minimal, coord, ratpub AND ros2, wind-ros2
  # -------------------------------------------------------------------------

  jazzy-linux-x86_64-gnu:
    runs-on: ubuntu-24.04
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: |
          sudo apt-get install -y curl git unzip clang
          sudo apt-get update --assume-yes && sudo apt-get install locales --assume-yes
          sudo locale-gen en_US en_US.UTF-8
          export LANG=en_US.UTF-8
          sudo apt-get install software-properties-common --assume-yes
          # ROS2 Jazzy
          sudo add-apt-repository universe -y
          sudo apt-get update --assume-yes
          sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
          sudo apt-get update --assume-yes && sudo apt-get install ros-dev-tools ros-jazzy-ros-base --assume-yes
      
      - name: Build Variants
        env:
          RUST_TARGET: x86_64-unknown-linux-gnu
        run: |
          source /opt/ros/jazzy/setup.bash
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          # Feature: embed-ros2-c
          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ros2-c
          mkdir -p dist/ros2 && cp target/$RUST_TARGET/release/minot dist/ros2/

          $CARGO_CMD --package mt_wind --bin wind-ros2-c --features ros2-c
          $CARGO_CMD --package minot --bin minot-coord
          
          # Copy root artifacts
          cp target/$RUST_TARGET/release/wind-ros2-c dist/

      - name: "Archive binary"
        run: |
          TARGET=x86_64-unknown-linux-gnu
          mv dist minot-jazzy-$TARGET
          tar czvf minot-jazzy-$TARGET.tar.gz minot-jazzy-$TARGET
          shasum -a 256 minot-jazzy-$TARGET.tar.gz > minot-jazzy-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-jazzy-x86_64-unknown-linux-gnu
          path: |
            *.tar.gz
            *.sha256

  jazzy-linux-aarch64-gnu:
    runs-on: ubuntu-24.04-arm
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: |
          sudo apt-get install -y curl git unzip clang
          sudo apt-get update --assume-yes && sudo apt-get install locales --assume-yes
          sudo locale-gen en_US en_US.UTF-8
          export LANG=en_US.UTF-8
          sudo apt-get install software-properties-common --assume-yes
          # ROS2 Jazzy
          sudo add-apt-repository universe -y
          sudo apt-get update --assume-yes
          sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
          sudo apt-get update --assume-yes && sudo apt-get install ros-dev-tools ros-jazzy-ros-base --assume-yes
      
      - name: Build Variants
        env:
          RUST_TARGET: aarch64-unknown-linux-gnu
        run: |
          source /opt/ros/jazzy/setup.bash
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ros2-c
          mkdir -p dist/ros2 && cp target/$RUST_TARGET/release/minot dist/ros2/

          $CARGO_CMD --package mt_wind --bin wind-ros2-c --features ros2-c
          
          cp target/$RUST_TARGET/release/wind-ros2-c dist/

      - name: "Archive binary"
        run: |
          TARGET=aarch64-unknown-linux-gnu
          mv dist minot-jazzy-$TARGET
          tar czvf minot-jazzy-$TARGET.tar.gz minot-jazzy-$TARGET
          shasum -a 256 minot-jazzy-$TARGET.tar.gz > minot-jazzy-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-jazzy-aarch64-unknown-linux-gnu
          path: |
            *.tar.gz
            *.sha256

  humble-linux-x86_64-gnu:
    runs-on: ubuntu-22.04
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: |
          sudo apt-get install -y curl git unzip clang
          sudo apt-get update --assume-yes && sudo apt-get install locales --assume-yes
          sudo locale-gen en_US en_US.UTF-8
          export LANG=en_US.UTF-8
          sudo apt-get install software-properties-common --assume-yes
          # ROS2 Humble
          sudo add-apt-repository universe -y
          sudo apt-get update --assume-yes
          sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
          sudo apt-get update --assume-yes && sudo apt-get install ros-dev-tools ros-humble-ros-base --assume-yes
      
      - name: Build Variants
        env:
          RUST_TARGET: x86_64-unknown-linux-gnu
        run: |
          source /opt/ros/humble/setup.bash
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ros2-c-humble
          mkdir -p dist/ros2 && cp target/$RUST_TARGET/release/minot dist/ros2/

          # 3. ROS2 + ROS1 Combined (ros2_1)
          # Feature: embed-ros2-c-humble,embed-ros1-native
          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ros2-c-humble,embed-ros1-native
          mkdir -p dist/ros2_1 && cp target/$RUST_TARGET/release/minot dist/ros2_1/

          # 4. Sidecars (wind-ros2-c, wind-ros1-native, minot-coord)
          $CARGO_CMD --package mt_wind --bin wind-ros2-c --features ros2-c,humble
          $CARGO_CMD --package mt_wind --bin wind-ros1-native --features ros1-native

          cp target/$RUST_TARGET/release/wind-ros2-c dist/
          cp target/$RUST_TARGET/release/wind-ros1-native dist/

      - name: "Archive binary"
        run: |
          TARGET=x86_64-unknown-linux-gnu
          mv dist minot-humble-$TARGET
          tar czvf minot-humble-$TARGET.tar.gz minot-humble-$TARGET
          shasum -a 256 minot-humble-$TARGET.tar.gz > minot-humble-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-humble-x86_64-unknown-linux-gnu
          path: |
            *.tar.gz
            *.sha256

  humble-linux-aarch64-gnu:
    runs-on: ubuntu-22.04-arm
    needs: [rust-stable-test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Dependencies
        run: |
          sudo apt-get install -y curl git unzip clang
          sudo apt-get update --assume-yes && sudo apt-get install locales --assume-yes
          sudo locale-gen en_US en_US.UTF-8
          export LANG=en_US.UTF-8
          sudo apt-get install software-properties-common --assume-yes
          # ROS2 Humble
          sudo add-apt-repository universe -y
          sudo apt-get update --assume-yes
          sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
          sudo apt-get update --assume-yes && sudo apt-get install ros-dev-tools ros-humble-ros-base --assume-yes
      
      - name: Build Variants
        env:
          RUST_TARGET: aarch64-unknown-linux-gnu
        run: |
          source /opt/ros/humble/setup.bash
          rustup target add $RUST_TARGET
          CARGO_CMD="cargo build --target $RUST_TARGET --release"

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ros2-c-humble
          mkdir -p dist/ros2 && cp target/$RUST_TARGET/release/minot dist/ros2/

          $CARGO_CMD --package minot --bin minot --features embed-coord,embed-ros2-c-humble,embed-ros1-native
          mkdir -p dist/ros2_1 && cp target/$RUST_TARGET/release/minot dist/ros2_1/

          $CARGO_CMD --package mt_wind --bin wind-ros2-c --features ros2-c,humble
          $CARGO_CMD --package mt_wind --bin wind-ros1-native --features ros1-native
          
          cp target/$RUST_TARGET/release/wind-ros2-c dist/
          cp target/$RUST_TARGET/release/wind-ros1-native dist/

      - name: "Archive binary"
        run: |
          TARGET=aarch64-unknown-linux-gnu
          mv dist minot-humble-$TARGET
          tar czvf minot-humble-$TARGET.tar.gz minot-humble-$TARGET
          shasum -a 256 minot-humble-$TARGET.tar.gz > minot-humble-$TARGET.tar.gz.sha256

      - name: "Upload binary"
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-humble-aarch64-unknown-linux-gnu
          path: |
            *.tar.gz
            *.sha256

  generate-manifest:
    runs-on: ubuntu-latest
    needs: [macos-x86_64, macos-aarch64, linux-x86_64-musl, linux-aarch64-gnu, linux-armv7-gnu, linux-x86_64-gnu, jazzy-linux-x86_64-gnu, humble-linux-x86_64-gnu, humble-linux-aarch64-gnu, jazzy-linux-aarch64-gnu]
    steps:
      - name: Generate feature manifest
        run: |
          cat > manifest.json <<'EOF'
          {
            "description": "Feature manifest for Minot releases. Each archive contains minot variants in subdirectories and shared artifacts in root.",
            "subdirs": {
              "min": "Minimal (no embeds)",
              "co": "Coord only (embed-coord)",
              "rat": "Coord + Ratpub (embed-coord, embed-ratpub)",
              "ros2": "Coord + ROS2-C (embed-coord, embed-ros2-c or embed-ros2-c-humble)",
              "ros2_1": "Coord + ROS2-C + ROS1 (embed-coord, embed-ros2-c-humble, embed-ros1-native)"
            },
            "targets": {
              "minot-x86_64-unknown-linux-musl": {
                "subdirs": ["min", "co", "rat"],
                "features": ["embed-coord", "embed-ratpub"],
                "root_artifacts": ["minot-coord", "wind-rat", "wind-ros2-native", "librat.a", "rat.h"]
              },
              "minot-x86_64-unknown-linux-gnu": {
                "subdirs": ["min", "co", "rat"],
                "features": ["embed-coord", "embed-ratpub"],
                "root_artifacts": ["minot-coord", "wind-rat", "wind-ros2-native", "wind-ros1-native", "librat.a", "librat.so", "rat.h"]
              },
              "minot-aarch64-unknown-linux-gnu": {
                "subdirs": ["min", "co", "rat"],
                "features": ["embed-coord", "embed-ratpub"],
                "root_artifacts": ["minot-coord", "wind-rat", "wind-ros2-native", "wind-ros1-native", "librat.a", "librat.so", "rat.h"]
              },
              "minot-armv7-unknown-linux-gnueabihf": {
                "subdirs": ["min", "co", "rat"],
                "features": ["embed-coord", "embed-ratpub"],
                "root_artifacts": ["minot-coord", "wind-rat", "wind-ros2-native", "wind-ros1-native", "librat.a", "librat.so", "rat.h"]
              },
              "minot-aarch64-apple-darwin": {
                "subdirs": ["min", "co", "rat"],
                "features": ["embed-coord", "embed-ratpub"],
                "root_artifacts": ["minot-coord", "wind-rat", "wind-ros2-native", "wind-ros1-native", "librat.a", "librat.dylib", "rat.h"]
              },
              "minot-x86_64-apple-darwin": {
                "subdirs": ["min", "co", "rat"],
                "features": ["embed-coord", "embed-ratpub"],
                "root_artifacts": ["minot-coord", "wind-rat", "wind-ros2-native", "wind-ros1-native", "librat.a", "librat.dylib", "rat.h"]
              },
              "minot-jazzy-x86_64-unknown-linux-gnu": {
                "subdirs": ["ros2"],
                "features": ["embed-coord", "embed-ros2-c"],
                "ros_distro": "jazzy",
                "root_artifacts": ["wind-ros2-c"],
                "requires_base_target": "minot-x86_64-unknown-linux-gnu"
              },
              "minot-jazzy-aarch64-unknown-linux-gnu": {
                "subdirs": ["ros2"],
                "features": ["embed-coord", "embed-ros2-c"],
                "ros_distro": "jazzy",
                "root_artifacts": ["wind-ros2-c"],
                "requires_base_target": "minot-aarch64-unknown-linux-gnu"
              },
              "minot-humble-x86_64-unknown-linux-gnu": {
                "subdirs": ["ros2", "ros2_1"],
                "features": ["embed-coord", "embed-ros2-c-humble", "embed-ros1-native"],
                "ros_distro": "humble",
                "root_artifacts": ["wind-ros2-c", "wind-ros1-native"],
                "requires_base_target": "minot-x86_64-unknown-linux-gnu"
              },
              "minot-humble-aarch64-unknown-linux-gnu": {
                "subdirs": ["ros2", "ros2_1"],
                "features": ["embed-coord", "embed-ros2-c-humble", "embed-ros1-native"],
                "ros_distro": "humble",
                "root_artifacts": ["wind-ros2-c", "wind-ros1-native"],
                "requires_base_target": "minot-aarch64-unknown-linux-gnu"
              }
            }
          }
          EOF
          cat manifest.json
      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: manifest.json

  create-release:
    runs-on: ubuntu-latest
    needs: [generate-manifest]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: List downloaded artifacts (for verification)
        run: ls -R artifacts
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: artifacts/**/*
          draft: true
          prerelease: false
